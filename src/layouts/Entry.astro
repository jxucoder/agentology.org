---
import Base from './Base.astro';
import { getCollection } from 'astro:content';

interface Props {
  frontmatter: {
    title: string;
    category: string;
    tags?: string[];
    related?: string[];
    status?: string;
    description?: string;
  };
}

const { frontmatter } = Astro.props;
const { title, category, tags = [], related = [], status, description } = frontmatter;

const categoryInfo: Record<string, { name: string }> = {
  archaeology: { name: 'Archaeology' },
  anatomy: { name: 'Anatomy' },
  taxonomy: { name: 'Taxonomy' },
  ethology: { name: 'Ethology' },
  linguistics: { name: 'Linguistics' },
  sociology: { name: 'Sociology' },
  ecology: { name: 'Ecology' },
  ethics: { name: 'Ethics' },
};

const cat = categoryInfo[category] || { name: category };

// Get related entries
const allEntries = await getCollection('entries');
const relatedEntries = allEntries.filter(entry =>
  related.includes(entry.slug) || related.includes(entry.data.title.toLowerCase().replace(/\s+/g, '-'))
);
---

<Base title={title} description={description}>
  <article class="animate-fade-in-up" data-pagefind-body>
    <!-- Header -->
    <header class="section border-b border-border-secondary">
      <div class="container-apple">
        <div class="max-w-3xl">
          <div class="flex items-center gap-3 mb-6">
            <a
              href={`/taxonomy?category=${category}`}
              class={`category-badge category-${category}`}
            >
              {cat.name}
            </a>
            {status === 'draft' && (
              <span class="text-caption font-medium text-amber-600 bg-amber-50 px-3 py-1 rounded-full">
                Draft
              </span>
            )}
          </div>

          <h1 class="text-display-md md:text-display-lg text-text-primary mb-6" data-pagefind-meta="title">
            {title}
          </h1>

          {description && (
            <p class="text-body-lg text-text-secondary" data-pagefind-meta="description">
              {description}
            </p>
          )}

          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-8">
              {tags.map((tag) => (
                <a href={`/taxonomy?tag=${tag}`} class="tag" data-pagefind-filter="tag">
                  {tag}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>
    </header>

    <!-- Content -->
    <section class="section">
      <div class="container-apple">
        <div class="max-w-3xl prose">
          <slot />
        </div>
      </div>
    </section>

    <!-- Related Entries -->
    {relatedEntries.length > 0 && (
      <section class="section-alt">
        <div class="container-apple">
          <h2 class="text-headline text-text-primary mb-8">Related Entries</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl">
            {relatedEntries.map((entry) => (
              <a
                href={`/entries/${entry.slug}`}
                class="card-hover p-6 group"
              >
                <span class={`category-badge category-${entry.data.category} mb-4`}>
                  {categoryInfo[entry.data.category]?.name}
                </span>
                <h3 class="text-title-sm text-text-primary group-hover:text-accent-blue transition-colors mb-2">
                  {entry.data.title}
                </h3>
                {entry.data.description && (
                  <p class="text-body-sm text-text-secondary line-clamp-2">{entry.data.description}</p>
                )}
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Navigation -->
    <section class="py-12 border-t border-border-secondary">
      <div class="container-apple">
        <div class="flex justify-between items-center max-w-3xl">
          <a href="/taxonomy" class="link-arrow text-body flex-row-reverse">
            <span class="rotate-180 inline-block mr-1">â€º</span>
            Browse all entries
          </a>
          <a href={`/taxonomy?category=${category}`} class="link-arrow text-body">
            More in {cat.name}
          </a>
        </div>
      </div>
    </section>
  </article>
</Base>

<style>
  .link-arrow.flex-row-reverse::after {
    content: none;
  }
</style>
