---
import Base from '../layouts/Base.astro';
import EntryCard from '../components/EntryCard.astro';
import { getCollection } from 'astro:content';

const categories = [
  { name: 'archaeology', slug: 'archaeology', code: 'ARCH' },
  { name: 'anatomy', slug: 'anatomy', code: 'ANAT' },
  { name: 'taxonomy', slug: 'taxonomy', code: 'TAXO' },
  { name: 'ethology', slug: 'ethology', code: 'ETHO' },
  { name: 'linguistics', slug: 'linguistics', code: 'LING' },
  { name: 'sociology', slug: 'sociology', code: 'SOCI' },
  { name: 'ecology', slug: 'ecology', code: 'ECOL' },
  { name: 'ethics', slug: 'ethics', code: 'ETHI' },
];

const allEntries = await getCollection('entries');

const categoryCounts = categories.map(cat => ({
  ...cat,
  count: allEntries.filter(e => e.data.category === cat.slug).length
}));
---

<Base title="BROWSE">
  <header class="mb-6 pb-3 border-b border-border-primary">
    <pre class="text-xs text-text-muted mb-2">
> query: list_all_entries
> status: {allEntries.length} records found
    </pre>
  </header>

  <section class="mb-6">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
      {categoryCounts.map((cat) => (
        <a
          href={`#${cat.slug}`}
          class="category-filter p-2 bg-bg-secondary border border-border-primary hover:border-text-primary transition-all animate-fade-in"
          data-category={cat.slug}
        >
          <div class="flex items-center justify-between">
            <span class="font-mono text-text-muted">[{cat.code}]</span>
            <span class="text-text-muted">{cat.count}</span>
          </div>
          <div class="font-mono text-text-secondary mt-1">{cat.name}</div>
        </a>
      ))}
    </div>
  </section>

  {categories.map((cat) => {
    const catEntries = allEntries.filter(e => e.data.category === cat.slug);
    return catEntries.length > 0 && (
      <section id={cat.slug} class="mb-8 category-section animate-fade-in" data-category={cat.slug}>
        <h2 class="text-sm font-mono text-text-primary mb-3 pb-1 border-b border-border-primary flex items-center justify-between">
          <span>[{cat.code}] {cat.name}</span>
          <span class="text-text-muted">{catEntries.length}</span>
        </h2>
        <div class="space-y-2">
          {catEntries.map((entry, index) => (
            <div style={`animation-delay: ${index * 50}ms`} class="animate-slide-in">
              <EntryCard
                title={entry.data.title}
                slug={entry.slug}
                category={entry.data.category}
                description={entry.data.description}
                status={entry.data.status}
              />
            </div>
          ))}
        </div>
      </section>
    );
  })}

  {allEntries.length === 0 && (
    <div class="text-center py-16">
      <p class="text-text-muted text-xs font-mono">no entries found</p>
    </div>
  )}
</Base>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');

    if (categoryParam) {
      const sections = document.querySelectorAll('.category-section');
      sections.forEach(section => {
        if (section.dataset.category !== categoryParam) {
          section.style.display = 'none';
        }
      });

      // Scroll to category
      const targetSection = document.getElementById(categoryParam);
      if (targetSection) {
        setTimeout(() => targetSection.scrollIntoView({ behavior: 'smooth' }), 100);
      }
    }
  });
</script>
