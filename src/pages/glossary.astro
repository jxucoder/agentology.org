---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('entries');

// Create glossary from entries - use title and description
const glossary = allEntries
  .map(entry => ({
    term: entry.data.title,
    definition: entry.data.description || 'No definition available.',
    slug: entry.slug,
    category: entry.data.category
  }))
  .sort((a, b) => a.term.localeCompare(b.term));

// Group by first letter
const grouped = glossary.reduce((acc, item) => {
  const letter = item.term[0].toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(item);
  return acc;
}, {} as Record<string, typeof glossary>);

const letters = Object.keys(grouped).sort();

const categoryInfo: Record<string, { icon: string }> = {
  archaeology: { icon: 'ðŸ›ï¸' },
  anatomy: { icon: 'ðŸ§ ' },
  taxonomy: { icon: 'ðŸŒ³' },
  ethology: { icon: 'ðŸ”„' },
  linguistics: { icon: 'ðŸ’¬' },
  sociology: { icon: 'ðŸ¤' },
  ecology: { icon: 'ðŸŒ' },
  ethics: { icon: 'âš–ï¸' },
};

// Core terms that should always appear in glossary
const coreTerms = [
  { term: 'Agent', definition: 'An AI system that can perceive its environment, make decisions, and take actions to achieve goals autonomously.' },
  { term: 'Agent Loop', definition: 'The fundamental cycle of observe â†’ reason â†’ act that defines agent behavior.' },
  { term: 'Autonomy', definition: 'The degree to which an agent can operate independently without human intervention.' },
  { term: 'Chain of Thought', definition: 'A prompting technique where the model explicitly reasons through steps before answering.' },
  { term: 'Context Window', definition: 'The maximum amount of text (tokens) a model can process in a single interaction.' },
  { term: 'Emergent Behavior', definition: 'Capabilities that arise from training but were not explicitly programmed.' },
  { term: 'Grounding', definition: 'Connecting an agent to external sources of truth or real-world data.' },
  { term: 'Hallucination', definition: 'When a model generates plausible-sounding but factually incorrect information.' },
  { term: 'In-Context Learning', definition: 'The ability to learn from examples provided within the prompt.' },
  { term: 'Prompt', definition: 'Instructions given to an AI model to guide its behavior and output.' },
  { term: 'ReAct', definition: 'A prompting paradigm combining Reasoning and Acting in an interleaved manner.' },
  { term: 'Scaffold', definition: 'External code or infrastructure that wraps a model to create an agent.' },
  { term: 'Tool Use', definition: 'The capability of an agent to interact with external APIs, databases, or systems.' },
  { term: 'Trajectory', definition: 'The sequence of observations, thoughts, and actions taken by an agent.' },
];

// Merge core terms with entry-derived terms
const allTerms = [...coreTerms];
glossary.forEach(g => {
  if (!allTerms.find(t => t.term.toLowerCase() === g.term.toLowerCase())) {
    allTerms.push(g);
  }
});

const allGrouped = allTerms.reduce((acc, item) => {
  const letter = item.term[0].toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(item);
  return acc;
}, {} as Record<string, typeof allTerms>);

const allLetters = Object.keys(allGrouped).sort();
---

<Base title="Glossary">
  <header class="mb-8">
    <h1 class="text-3xl font-bold font-mono text-text-primary mb-2">
      Glossary
    </h1>
    <p class="text-text-secondary">
      Quick definitions of key terms in agentology.
    </p>
  </header>

  <!-- Letter Navigation -->
  <nav class="mb-8 flex flex-wrap gap-2">
    {allLetters.map((letter) => (
      <a
        href={`#letter-${letter}`}
        class="w-8 h-8 flex items-center justify-center font-mono text-sm bg-bg-secondary border border-border-primary rounded hover:border-accent-primary hover:text-accent-primary transition-colors"
      >
        {letter}
      </a>
    ))}
  </nav>

  <!-- Glossary Entries -->
  <div class="space-y-8">
    {allLetters.map((letter) => (
      <section id={`letter-${letter}`}>
        <h2 class="text-2xl font-mono font-bold text-accent-primary mb-4 pb-2 border-b border-border-primary">
          {letter}
        </h2>
        <dl class="space-y-4">
          {allGrouped[letter].sort((a, b) => a.term.localeCompare(b.term)).map((item) => (
            <div class="glossary-entry p-4 bg-bg-secondary border border-border-primary rounded-lg hover:border-border-primary/80 transition-colors">
              <dt class="font-mono font-semibold text-text-primary flex items-center gap-2">
                {'slug' in item ? (
                  <a href={`/entries/${item.slug}`} class="hover:text-accent-primary transition-colors">
                    {item.term}
                  </a>
                ) : (
                  item.term
                )}
                {'category' in item && item.category && (
                  <span class="text-sm">{categoryInfo[item.category]?.icon}</span>
                )}
              </dt>
              <dd class="text-text-secondary text-sm mt-1">
                {item.definition}
              </dd>
            </div>
          ))}
        </dl>
      </section>
    ))}
  </div>

  {allTerms.length === 0 && (
    <div class="text-center py-16">
      <span class="text-4xl mb-4 block">ðŸ“–</span>
      <p class="text-text-secondary">The glossary is being compiled. Check back soon!</p>
    </div>
  )}
</Base>
