---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('entries');

// Create glossary from entries - use title and description
const glossary = allEntries
  .map(entry => ({
    term: entry.data.title,
    definition: entry.data.description || 'No definition available.',
    slug: entry.slug,
    category: entry.data.category
  }))
  .sort((a, b) => a.term.localeCompare(b.term));

// Group by first letter
// Unused, kept for potential future use
// const grouped = glossary.reduce((acc, item) => {
//   const letter = item.term[0].toUpperCase();
//   if (!acc[letter]) acc[letter] = [];
//   acc[letter].push(item);
//   return acc;
// }, {} as Record<string, typeof glossary>);

const categoryInfo: Record<string, { code: string }> = {
  archaeology: { code: 'ARCH' },
  anatomy: { code: 'ANAT' },
  taxonomy: { code: 'TAXO' },
  ethology: { code: 'ETHO' },
  linguistics: { code: 'LING' },
  sociology: { code: 'SOCI' },
  ecology: { code: 'ECOL' },
  ethics: { code: 'ETHI' },
};

// Core terms that should always appear in glossary
const coreTerms = [
  { term: 'Agent', definition: 'autonomous system: perceive → decide → act' },
  { term: 'Agent Loop', definition: 'observe → reason → act cycle' },
  { term: 'Autonomy', definition: 'independent operation capacity without human intervention' },
  { term: 'Chain of Thought', definition: 'explicit reasoning steps before output generation' },
  { term: 'Context Window', definition: 'maximum token capacity per interaction' },
  { term: 'Emergent Behavior', definition: 'unprogrammed capabilities arising from training' },
  { term: 'Grounding', definition: 'external truth source connection' },
  { term: 'Hallucination', definition: 'plausible but factually incorrect generation' },
  { term: 'In-Context Learning', definition: 'learning from prompt-embedded examples' },
  { term: 'Prompt', definition: 'instruction set guiding model behavior' },
  { term: 'ReAct', definition: 'reasoning + acting interleaved paradigm' },
  { term: 'Scaffold', definition: 'infrastructure wrapping model to create agent' },
  { term: 'Tool Use', definition: 'external system interaction capability' },
  { term: 'Trajectory', definition: 'observation-thought-action sequence' },
];

// Merge core terms with entry-derived terms
const allTerms = [...coreTerms];
glossary.forEach(g => {
  if (!allTerms.find(t => t.term.toLowerCase() === g.term.toLowerCase())) {
    allTerms.push(g);
  }
});

const allGrouped = allTerms.reduce((acc, item) => {
  const letter = item.term[0].toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(item);
  return acc;
}, {} as Record<string, typeof allTerms>);

const allLetters = Object.keys(allGrouped).sort();
---

<Base title="GLOSSARY">
  <header class="mb-6 pb-3 border-b border-border-primary">
    <pre class="text-xs text-text-muted mb-2">
> query: list_terms
> status: {allTerms.length} definitions loaded
    </pre>
  </header>

  <nav class="mb-6 flex flex-wrap gap-1 text-xs">
    {allLetters.map((letter) => (
      <a
        href={`#${letter}`}
        class="w-6 h-6 flex items-center justify-center font-mono bg-bg-secondary border border-border-primary hover:border-text-primary hover:text-text-primary transition-all"
      >
        {letter}
      </a>
    ))}
  </nav>

  <div class="space-y-6">
    {allLetters.map((letter) => (
      <section id={letter} class="animate-fade-in">
        <h2 class="text-sm font-mono font-bold text-text-primary mb-2 pb-1 border-b border-border-primary">
          {letter}
        </h2>
        <dl class="space-y-1 text-xs">
          {allGrouped[letter].sort((a, b) => a.term.localeCompare(b.term)).map((item) => (
            <div class="glossary-entry p-2 bg-bg-secondary border-l-2 border-transparent hover:border-text-primary hover:bg-bg-tertiary transition-all">
              <dt class="font-mono text-text-secondary flex items-center gap-2">
                {'slug' in item ? (
                  <a href={`/entries/${item.slug}`} class="hover:text-text-primary transition-colors">
                    {item.term}
                  </a>
                ) : (
                  <span class="text-text-primary">{item.term}</span>
                )}
                {'category' in item && item.category && typeof item.category === 'string' && (
                  <span class="text-text-muted">[{categoryInfo[item.category as keyof typeof categoryInfo]?.code}]</span>
                )}
              </dt>
              <dd class="text-text-muted mt-0.5 pl-2">
                {item.definition}
              </dd>
            </div>
          ))}
        </dl>
      </section>
    ))}
  </div>

  {allTerms.length === 0 && (
    <div class="text-center py-16">
      <p class="text-text-muted text-xs font-mono">no definitions found</p>
    </div>
  )}
</Base>
