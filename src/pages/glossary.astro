---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('entries');

const glossary = allEntries
  .map(entry => ({
    term: entry.data.title,
    definition: entry.data.description || 'No definition available.',
    slug: entry.slug,
    category: entry.data.category
  }))
  .sort((a, b) => a.term.localeCompare(b.term));

const categoryInfo: Record<string, { name: string }> = {
  archaeology: { name: 'Archaeology' },
  anatomy: { name: 'Anatomy' },
  taxonomy: { name: 'Taxonomy' },
  ethology: { name: 'Ethology' },
  linguistics: { name: 'Linguistics' },
  sociology: { name: 'Sociology' },
  ecology: { name: 'Ecology' },
  ethics: { name: 'Ethics' },
};

const coreTerms = [
  { term: 'Agent', definition: 'An autonomous system capable of perception, decision-making, and action.' },
  { term: 'Agent Loop', definition: 'The continuous cycle of observe, reason, and act that drives agent behavior.' },
  { term: 'Autonomy', definition: 'The capacity for independent operation without human intervention.' },
  { term: 'Chain of Thought', definition: 'Explicit reasoning steps generated before producing a final output.' },
  { term: 'Context Window', definition: 'The maximum token capacity available per interaction with a model.' },
  { term: 'Emergent Behavior', definition: 'Capabilities that arise from training but were not explicitly programmed.' },
  { term: 'Grounding', definition: 'Connection to external truth sources for fact verification.' },
  { term: 'Hallucination', definition: 'Plausible but factually incorrect content generated by a model.' },
  { term: 'In-Context Learning', definition: 'Learning from examples embedded within the prompt.' },
  { term: 'Prompt', definition: 'An instruction set that guides model behavior and output.' },
  { term: 'ReAct', definition: 'A paradigm that interleaves reasoning and acting for better task completion.' },
  { term: 'Scaffold', definition: 'Infrastructure that wraps a model to create an agent with extended capabilities.' },
  { term: 'Tool Use', definition: 'The capability to interact with external systems and APIs.' },
  { term: 'Trajectory', definition: 'A sequence of observations, thoughts, and actions recorded during agent execution.' },
];

const allTerms = [...coreTerms];
glossary.forEach(g => {
  if (!allTerms.find(t => t.term.toLowerCase() === g.term.toLowerCase())) {
    allTerms.push(g);
  }
});

const allGrouped = allTerms.reduce((acc, item) => {
  const letter = item.term[0].toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(item);
  return acc;
}, {} as Record<string, typeof allTerms>);

const allLetters = Object.keys(allGrouped).sort();
---

<Base title="Glossary">
  <!-- Header -->
  <section class="section border-b border-border-secondary">
    <div class="container-apple text-center">
      <h1 class="text-display-md text-text-primary mb-4">Glossary</h1>
      <p class="text-body-lg text-text-secondary">
        {allTerms.length} terms and definitions
      </p>
    </div>
  </section>

  <!-- Letter Navigation -->
  <section class="py-6 border-b border-border-secondary sticky top-14 bg-bg-primary/80 backdrop-blur-xl z-30">
    <div class="container-apple">
      <div class="flex flex-wrap justify-center gap-2">
        {allLetters.map((letter) => (
          <a
            href={`#${letter}`}
            class="w-10 h-10 flex items-center justify-center text-body font-medium text-text-muted
                   bg-bg-secondary rounded-apple-sm hover:bg-border-secondary hover:text-text-primary
                   transition-all"
          >
            {letter}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Terms -->
  <section class="section">
    <div class="container-apple">
      <div class="max-w-3xl mx-auto space-y-16">
        {allLetters.map((letter) => (
          <div id={letter} class="scroll-mt-32">
            <div class="flex items-center gap-4 mb-6">
              <span class="text-display-sm font-semibold text-text-primary">{letter}</span>
              <div class="flex-1 h-px bg-border-secondary"></div>
            </div>

            <div class="space-y-4">
              {allGrouped[letter].sort((a, b) => a.term.localeCompare(b.term)).map((item) => (
                <div class="group">
                  {'slug' in item ? (
                    <a href={`/entries/${item.slug}`} class="block card-hover p-5">
                      <div class="flex items-start justify-between gap-4">
                        <div>
                          <h3 class="text-title-sm text-text-primary group-hover:text-accent-blue transition-colors mb-1">
                            {item.term}
                          </h3>
                          <p class="text-body-sm text-text-secondary">
                            {item.definition}
                          </p>
                        </div>
                        {'category' in item && item.category && (
                          <span class={`category-badge category-${item.category} shrink-0`}>
                            {categoryInfo[item.category as keyof typeof categoryInfo]?.name}
                          </span>
                        )}
                      </div>
                    </a>
                  ) : (
                    <div class="bg-bg-secondary rounded-apple-lg p-5">
                      <h3 class="text-title-sm text-text-primary mb-1">{item.term}</h3>
                      <p class="text-body-sm text-text-secondary">{item.definition}</p>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>
</Base>
